name: Build Android APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkoutä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®JavaçŽ¯å¢ƒ
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: è®¾ç½®FlutterçŽ¯å¢ƒ
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.0'
          channel: 'stable'
          cache: false

      - name: å®Œå…¨æ¸…ç†å¹¶é‡æ–°ç”Ÿæˆ
        run: |
          echo "=== æ¸…ç†æ‰€æœ‰ç¼“å­˜å’Œç”Ÿæˆçš„æ–‡ä»¶ ==="
          flutter clean
          cd android
          ./gradlew clean
          cd ..
          rm -rf .dart_tool
          rm -f pubspec.lock
          rm -rf build
          echo "âœ… æ¸…ç†å®Œæˆ"

      - name: èŽ·å–ä¾èµ–å¹¶ç”Ÿæˆæ–‡ä»¶
        run: |
          flutter pub get
          echo "âœ… ä¾èµ–èŽ·å–å®Œæˆ"
          # é¢„æž„å»ºä»¥ç”ŸæˆGeneratedPluginRegistrant.java
          flutter build apk --debug --target-platform android-arm64
          echo "âœ… é¢„æž„å»ºå®Œæˆï¼ŒGeneratedPluginRegistrant.javaå·²ç”Ÿæˆ"
          echo "=== æ£€æŸ¥GeneratedPluginRegistrant ==="
          head -20 android/app/src/main/java/io/flutter/plugins/GeneratedPluginRegistrant.java

      - name: æ£€æŸ¥V2 Embeddingé…ç½®
        run: |
          echo "=== MainActivity.kt (V2 Embedding) ==="
          cat android/app/src/main/kotlin/com/aeryn/deutsch/MainActivity.kt
          echo ""
          echo "=== AndroidManifest.xml (flutterEmbedding) ==="
          grep -A 2 "flutterEmbedding" android/app/src/main/AndroidManifest.xml

      - name: æž„å»ºAPK (Release)
        run: |
          echo "å¼€å§‹æž„å»ºAPK..."
          flutter build apk --release --target-platform android-arm,android-arm64,android-x64

      - name: ä¸Šä¼ APK
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: app-release-apk
          path: build/app/outputs/flutter-apk/app-release.apk
          retention-days: 30

      - name: æž„å»ºæˆåŠŸä¿¡æ¯
        if: success()
        run: |
          echo "## ðŸŽ‰ æž„å»ºæˆåŠŸï¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **åˆ†æ”¯**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **APKä½ç½®**: Artifacts â†’ app-release-apk" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ä¸‹è½½æ­¥éª¤" >> $GITHUB_STEP_SUMMARY
          echo "1. ç‚¹å‡»æž„å»ºè®°å½•" >> $GITHUB_STEP_SUMMARY
          echo "2. æ»šåŠ¨åˆ°åº•éƒ¨ Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "3. ä¸‹è½½ app-release-apk" >> $GITHUB_STEP_SUMMARY
          echo "4. è§£åŽ‹å¾—åˆ° app-release.apk" >> $GITHUB_STEP_SUMMARY
